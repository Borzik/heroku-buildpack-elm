#!/bin/bash

set -eo pipefail

indent() {
  sed -u 's/^/       /'
}

mkdir -p "$1" "$2"
build=$(cd "$1/" && pwd)
cache=$(cd "$2/" && pwd)
buildpack=$(cd "$(dirname $0)/.." && pwd)

ELM_VERSION=${ELM_VERSION:-0.15}
VERSION=elm-${ELM_VERSION}:spas-0.1.0.0
S3_URL=https://s3.amazonaws.com/heroku-buildpack-elm/assets/${VERSION}

mkdir -p ${cache}/bin
cd ${cache}/bin
echo "-----> Retrieving Elm binaries"
curl -sO ${S3_URL}/elm
curl -sO ${S3_URL}/elm-package
curl -sO ${S3_URL}/elm-make

if grep --quiet spas ${build}/Procfile; then
   echo "-----> Retrieving Spas"
   curl -sO ${S3_URL}/spas
   mkdir -p ${build}/bin
   cp spas ${build}/bin
fi

chmod -R a+x ${cache}/bin ${build}/bin
PATH=${cache}/bin:$PATH

cd ${build}
echo "-----> Installing Elm package dependencies"
elm package install --yes
echo "-----> Compiling"
elm make ${ELM_MAIN}

mkdir -p $build/.profile.d
echo 'PATH=$PATH:$HOME/bin' > $build/.profile.d/elm.sh